{
  "meta": {
    "name": "apt29_powershell_bypass",
    "rule_id": "033fe7d6-66d1-4240-ac6b-28908009c71f",
    "version": "v1.1",
    "technique_id": "T1548.002",
    "description": "APT29 PowerShell UAC bypass technique with full wrapper and obfuscation support",
    "max_payload_len": 1024
  },
  "terminals": {
    "executables": [
      { "tok": "powershell.exe", "weight": 1.0 },
      { "tok": "powershell", "weight": 0.8 },
      { "tok": "pwsh.exe", "weight": 0.6 },
      { "tok": "pwsh", "weight": 0.5 },
      { "tok": "%SystemRoot%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe", "weight": 0.3 }
    ],
    "separators": [
      { "tok": " ", "weight": 1.0 },
      { "tok": "\t", "weight": 0.2 },
      { "tok": ",", "weight": 0.1 }
    ],
    "noni_flags": [
      { "tok": "-noni", "weight": 1.0 },
      { "tok": "-NonInteractive", "weight": 0.8 },
      { "tok": "-NonI", "weight": 0.6 },
      { "tok": "-ni", "weight": 0.2 }
    ],
    "ep_flags": [
      { "tok": "-ep", "weight": 1.0 },
      { "tok": "-ExecutionPolicy", "weight": 0.8 },
      { "tok": "-Exec", "weight": 0.5 }
    ],
    "bypass_values": [
      { "tok": "bypass", "weight": 1.0 },
      { "tok": "Bypass", "weight": 0.9 },
      { "tok": "Unrestricted", "weight": 0.4 }
    ],
    "script_blocks": [
      { "tok": "$env:TEMP", "weight": 1.0 },
      { "tok": "$PSVersionTable", "weight": 0.8 },
      { "tok": "$x=1;Write-Host 'test'", "weight": 0.8 },
      { "tok": "Write-Host 'test';$", "weight": 0.5 }
    ],
    "wrappers": [
      { "fmt": "{payload}", "weight": 1.0 },
      { "fmt": "cmd.exe /c \"{payload}\"", "weight": 0.5 },
      { "fmt": "cmd /r \"{payload}\"", "weight": 0.4 },
      { "fmt": "echo {payload} | cmd", "weight": 0.3 },
      { "fmt": "%COMSPEC% /c {payload}", "weight": 0.3 }
    ],
    "noise": [
      { "tok": "", "weight": 0.6 },
      { "tok": "\"\"", "weight": 0.2 },
      { "tok": "^", "weight": 0.1 },
      { "tok": "&::", "weight": 0.1 }
    ]
  },
  "obfuscation_groups": {
    "caret_escape": {
      "target_terminals": ["executables", "noni_flags", "ep_flags", "bypass_values"],
      "operators": [
        { "name": "random_caret", "sample": "p^o^wershell", "prob": 0.3 }
      ]
    },
    "quote_wrap": {
      "target_terminals": ["executables", "bypass_values", "script_blocks"],
      "operators": [
        { "name": "double_quote", "sample": "\"powershell.exe\"", "prob": 0.25 },
        { "name": "single_quote_arg", "sample": "'bypass'", "prob": 0.15 }
      ]
    },
    "case_variants": {
      "target_terminals": ["executables", "noni_flags", "ep_flags", "bypass_values"],
      "operators": [
        { "name": "upper", "sample": "POWERSHELL", "prob": 0.15 },
        { "name": "mixed", "sample": "PoWeRsHeLl", "prob": 0.10 },
        { "name": "camel", "sample": "PowerShell", "prob": 0.20 }
      ]
    }
  },
  "rules": {
    "entry_point": {
      "type": "structure",
      "components": [
        { "type": "choose", "from": "wrappers", "params": { "payload": "payload_core" } }
      ]
    },
    "payload_core": {
      "type": "sequence",
      "structures": [
        [
          { "type": "choose", "from": "executables" },
          { "type": "choose", "from": "separators" },
          { "type": "choose", "from": "noise" },
          { "type": "choose", "from": "noni_flags" },
          { "type": "choose", "from": "separators" },
          { "type": "choose", "from": "noise" },
          { "type": "choose", "from": "ep_flags" },
          { "type": "choose", "from": "separators" },
          { "type": "choose", "from": "bypass_values" },
          { "type": "choose", "from": "separators" },
          { "type": "literal", "tok": "-Command" },
          { "type": "choose", "from": "separators" },
          { "type": "choose", "from": "script_blocks" }
        ]
      ]
    }
  },
  "constraints": {
    "must_contain_all": ["-ep", "bypass", "$"],
    "regex_match": "(?i).*powershell.*(-noni|-ni).*(-ep|-exec).*bypass.*\\$.*"
  },
  "mutation_engine": {
    "max_mutations": 5,
    "preserve_keywords": true,
    "strategies": ["replace_token", "insert_noise", "apply_obfuscation"]
  },
  "sampling": {
    "strategy": "weighted_random",
    "epsilon_seed": 0.2,
    "epsilon_group": 0.15,
    "seed": 42
  }
}